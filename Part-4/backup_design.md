# Проектирование системы резервного копирования

## Цели системы
Обеспечить сохранность критически важных данных инфраструктуры для минимизации потерь при сбоях (например, удаление файлов, сбой сервера).

## План реализации
Система бэкапирования предназначена для сохранения конфигураций VPN-сервера и CA-сервера:
1. **Скрипт `backup.sh`**:
   - Создаёт архивы конфигураций:
     - VPN-сервер: `/etc/openvpn`, `/etc/prometheus`, `/etc/alertmanager`, `/var/log/openvpn`.
     - CA-сервер: `/home/superpokemon25/easy-rsa/pki`.
   - Передаёт архивы на ca-server в `/backup` через `scp`.
   - Отправляет уведомления через Alertmanager о статусе бэкапирования.
2. **Deb-пакет `my-backup-package`**:
   - Автоматизирует установку скрипта и настройку cron-задачи.
3. **Cron-задача**:
   - Запускает бэкап ежедневно в 02:00 UTC.

## Объекты бэкапа
- **vpn-server**:
  - Конфигурации OpenVPN: `/etc/openvpn`.
  - Конфигурации мониторинга: `/etc/prometheus`, `/etc/alertmanager`.
  - Логи OpenVPN: `/var/log/openvpn`.
- **ca-server**:
  - Файлы PKI: `/home/superpokemon25/easy-rsa/pki`.

## Место хранения
- Локально на ca-server: `/backup` (централизованное хранилище).
- Бэкапы передаются с vpn-server на ca-server по SSH.

## Частота бэкапирования
- Ежедневно в 02:00 UTC.

## Сценарии отказа
1. **Потеря данных на ca-server (например, удаление `/home/superpokemon25/easy-rsa/pki`)**:
   - Действие: Восстановить из последнего бэкапа, уведомить администратора.
   - Уведомление: Отправить email через Alertmanager.
2. **Сбой vpn-server (например, недоступность OpenVPN)**:
   - Действие: Перезапустить сервер, восстановить конфигурации из бэкапа на ca-server.
   - Уведомление: Отправить email через Alertmanager.
3. **Ошибка бэкапирования (например, недоступность ca-server)**:
   - Действие: Сохранить бэкап локально на vpn-server (в `/tmp/backup`), повторить попытку через 1 час.
   - Уведомление: Отправить email с ошибкой.
4. **Отказ диска на vpn-server**:
   - Действие: Восстановить конфигурации из бэкапа на ca-server, пересоздать машину в Yandex Cloud.
5. **Компрометация ключей CA-сервера**:
   - Действие: Пересоздать CA, выпустить новые сертификаты, обновить VPN-сервер.

## Автоматизация
- Скрипт `backup.sh` на vpn-server для создания и отправки бэкапов.
- Deb-пакет `my-backup-package` для установки зависимостей и настройки.
- Cron-задание для ежедневного запуска.

## Уведомления
- Использовать Alertmanager для отправки email-уведомлений на адрес `super.pokemon25@yandex.ru`.

## Безопасность
- Директория `/backup` на ca-server доступна только пользователю `superpokemon25` (права 700).
- Передача бэкапов по SSH с использованием ключа.
- iptables на ca-server настроены (порт 22 для SSH, порт 9100 для `node_exporter`).

## Рекомендации
- Использовать снапшоты Yandex Cloud для дополнительного бэкапирования ca-server.
- Развернуть Git-репозиторий для хранения скриптов и deb-пакетов.
