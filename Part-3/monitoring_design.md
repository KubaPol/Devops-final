Проектирование системы мониторинга
Цели системы
Обеспечить постоянный контроль состояния инфраструктуры, включающей VPN-сервер и удостоверяющий центр (CA), с целью оперативного обнаружения и устранения неполадок. Система должна уведомлять администратора о проблемах, минимизируя время простоя.
Архитектура

Сервер мониторинга: Развёрнут на VPN-сервере (89.169.172.156) с использованием Prometheus, Grafana и Alertmanager.
Экспортёры:
node_exporter (порт 9100) на обоих серверах (vpn-server и ca-server) для сбора метрик операционной системы (CPU, память, диск).
openvpn-exporter (порт 9176) на vpn-server для мониторинга метрик OpenVPN.


Хранилище метрик: Prometheus собирает данные с экспортёров и хранит их локально.
Визуализация: Grafana (порт 3000) предоставляет интерфейс для анализа графиков.
Уведомления: Alertmanager (порт 9093) отправляет оповещения на email super.pokemon25@yandex.ru.

Собираемые метрики
Инфраструктурные метрики (node_exporter)

Процент использования CPU.
Доступная оперативная память.
Свободное место на диске, особенно в / и /backup на ca-server.
Скорость передачи данных по сети.

Метрики OpenVPN (openvpn-exporter)

Количество подключённых клиентов.
Объём входящего и исходящего трафика.
Статус доступности OpenVPN-сервиса.

Настроенные алерты
Все алерты определены в /etc/prometheus/rules/openvpn_alerts.yml и включают:

NoConnectedClients: Количество подключённых клиентов < 1 в течение 5 минут (severity: critical).
LowTrafficAlert: Скорость входящего трафика < 1000 байт/с в течение 10 минут (severity: warning).
HighTrafficAlert: Скорость входящего трафика > 1 МБ/с в течение 10 минут (severity: warning).
OpenVPNDown: Отсутствие ответа от openvpn-exporter в течение 2 минут (severity: critical).
TooManyClients: Количество клиентов > 100 в течение 5 минут (severity: warning).
HighCPUUsage: Использование CPU > 80% в течение 5 минут (severity: warning).
LowDiskSpace: Свободное место на диске < 20% в течение 5 минут (severity: warning).
HighMemoryUsage: Использование памяти > 80% в течение 5 минут (severity: warning).

Настройка уведомлений

Alertmanager настроен на отправку email через SMTP Yandex (smtp.yandex.com:587) с авторизацией на super.pokemon25@yandex.ru.
Уведомления группируются по имени алерта с интервалом повторения 1 час.

Автоматизация

Установка и настройка осуществляется через deb-пакет my-monitoring-package_1.0-1_all.deb.
Скрипт postinst обеспечивает установку Prometheus, Alertmanager, openvpn-exporter и конфигурацию алертов.

Безопасность

Доступ к портам 9090 (Prometheus), 3000 (Grafana) и 9093 (Alertmanager) ограничен через iptables.
Конфигурации хранятся в защищённых директориях с правами доступа только для пользователя prometheus.

Проверить доступность метрик через http://89.169.172.156:9090/classic/alerts и http://89.169.172.156:3000/d/y_KAxA3Zz/openvpn-metrics?orgId=1&refresh=1m.


